"use strict";(()=>{document.cookie.split(";").some(t=>t.startsWith("_t="))||(alert("Please login to CHUNITHM-NET first."),location.href="https://chunithm-net-eng.com");typeof GM_fetch<"u"&&(window.fetch=GM_fetch);console.log("KTIMPORT");var _="__ktimport__",g="prod",w={prod:{baseUrl:"https://kamaitachi.xyz",clientId:"CI2a215ade610e60ee433a1f1faf0f2615f250e80d"}},I=w[g].baseUrl,$=w[g].clientId,M=["Basic","Advanced","Expert","Master","Ultima"],k=["DAN_I","DAN_II","DAN_III","DAN_IV","DAN_V","DAN_INFINITE"];function d(t,n=null){return localStorage.getItem(`${_}${t}_${g}`)??n}function x(t,n){localStorage.setItem(`${_}${t}_${g}`,n)}function y(t,n){let e=t.querySelector(n)?.innerText.replace(/,/gu,"");if(!e)throw new Error("Could not retrieve number.");return Number(e)}function C(t){let n=/([0-9]{4})\/([0-9]{1,2})\/([0-9]{1,2}) ([0-9]{1,2}):([0-9]{2})/u.exec(t);if(!n||n.length!==6)throw new Error("Invalid timestamp format. Expected yyyy/MM/dd HH:mm.");let[e,r,s,o,c,i]=n,u=s.padStart(2,"0"),m=o.padStart(2,"0"),p=c.padStart(2,"0"),f=`${r}-${u}-${m}T${p}:${i}:00.000+09:00`;return new Date(f)}function N(t,n){let e=t.querySelector(n)?.src;if(!e)throw new Error(`Could not determine image source for element ${t.outerHTML} with selector ${n}`);let r=e.split("/").pop()?.split(".")?.[0]?.split("_")?.[1]?.toUpperCase();if(typeof r>"u")throw new Error(`Could not determine difficulty from image URL ${e}`);return r==="ULTIMATE"&&(r="ULTIMA"),r==="WORLDSEND"&&(r="WORLD'S END"),r}function A(t,n){let e=t.some(o=>o.includes("icon_clear")||o.includes("icon_hard")||o.includes("icon_absolute")||o.includes("icon_absolutep")||o.includes("icon_catastrophy")),r=t.some(o=>o.includes("icon_fullcombo"));return t.some(o=>o.includes("icon_alljustice"))?n?.justice===0&&n.attack===0&&n.miss===0?"ALL JUSTICE CRITICAL":"ALL JUSTICE":r?"FULL COMBO":e?"CLEAR":"FAILED"}function l(t){let n=document.querySelector("#kt-import-status");n||(n=document.createElement("p"),n.id="kt-import-status",n.style.cssText="text-align: center; background-color: #fff;",document.querySelector(".title")?.insertAdjacentElement("afterend",n)),n.innerText=t}async function*H(t=document,n=0){let e=t.querySelectorAll(".frame02.w400"),r="Fetching scores";n&&(r=`${r} newer than ${new Date(n).toLocaleDateString()}`),r=`${r}...`,l(r);for(let s=0;s<e.length;s++){let o=e[s];if(!o){console.warn(`There was a hole in the NodeList? Element with index ${s} was null/undefined.`);continue}let c=o.querySelector(".play_datalist_date, .box_inner01")?.innerText;if(!c){console.warn(`Could not retrieve timestamp for score with index ${s}.`);continue}let i=C(c).valueOf();if(i<n)break;let u=N(o,".play_track_result img");if(u==="WORLD'S END")continue;let m=o.querySelector("input[name=idx]")?.value,p=o.querySelector("input[name=token]")?.value;if(!m||!p){console.warn(`Could not retrieve parameters for fetching details of score with index ${s}`);continue}let f=await fetch("/mobile/record/playlog/sendPlaylogDetail/",{method:"POST",body:`idx=${m}&token=${p}`,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(b=>b.text()),a=new DOMParser().parseFromString(f,"text/html"),E=a.querySelector(".play_data_detail_ranking_btn input[name=idx]")?.value;if(!E){console.warn(`Missing inGameID input element for score index ${s}`);continue}let T={jcrit:y(a,".text_critical"),justice:y(a,".text_justice"),attack:y(a,".text_attack"),miss:y(a,".text_miss")},P=[...a.querySelectorAll(".play_musicdata_icon img")].map(b=>b.src);yield{score:y(a,".play_musicdata_score_text"),lamp:A(P,T),matchType:"inGameID",identifier:E,difficulty:u,timeAchieved:i,judgements:T,optional:{maxCombo:y(a,".play_data_detail_maxcombo_block")}}}}async function*R(t=document){let n=t.querySelector("input[name=token]")?.value??t.cookie.split(";").find(e=>e.startsWith("_t="))?.split("=")[1];if(!n){l("Error: No token found");return}for(let e of M){l(`Fetching scores for ${e}...`);let r=await fetch(`/mobile/record/musicGenre/send${e}`,{method:"POST",body:`genre=99&token=${n}`,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(c=>c.text()),o=new DOMParser().parseFromString(r,"text/html").querySelectorAll(".musiclist_box");for(let c of o){let i=c.querySelector(".play_musicdata_highscore .text_b"),u=c.querySelector("input[name=idx]")?.value;if(!i?.innerText||!u)continue;let m=Number(i.innerText.replace(/,/gu,"")),p=[...c.querySelectorAll(".play_musicdata_icon img")].map(a=>a.src);yield{score:m,lamp:A(p),matchType:"inGameID",identifier:u,difficulty:e.toUpperCase()}}}}async function L(t,n){let e=await fetch(t,{method:"GET",headers:{Authorization:`Bearer ${d("api-key")}`}}).then(o=>o.json());if(!e.success){l(`Terminal error: ${e.description}`);return}if(e.body.importStatus==="ongoing"){let o=typeof e.body.progress=="number"?e.body.progress.toString():e.body.progress.description;l(`Importing scores... ${e.description} Progress: ${o}`),setTimeout(L,1e3,t,n);return}console.debug(e.body);let{latestTimestamp:r}=n,s=`${e.description} ${e.body.import.scoreIDs.length} scores`;for(let o of e.body.import.classDeltas)s=`${s} and ${o.set} ${o.new}`;if(e.body.import.errors.length>0){s=`${s}, ${e.body.import.errors.length} > 0 (check console for details)`;for(let o of e.body.import.errors)console.error(`${o.type}: ${o.message}`)}l(s),r&&x("latest-score-date",r.toString())}async function S(t){let{scores:n=[],classes:e}=t;if(n.length===0&&!e?.dan&&!e?.emblem){l("Nothing to import.");return}let s=JSON.stringify({meta:{game:"chunithm",playtype:"Single",service:"site-importer"},scores:n,classes:e});console.debug(s),document.querySelector("#kt-import-button")?.remove(),l("Submitting scores...");let o=await fetch(`${I}/ir/direct-manual/import`,{method:"POST",headers:{authorization:`Bearer ${d("api-key")}`,"content-type":"application/json","x-user-intent":"true"},body:s}).then(i=>i.json());if(!o.success){l(`Could not submit scores to Kamaitachi: ${o.description}`);return}let c=o.body.url;l("Importing scores..."),await L(c,t)}async function D(t=document){let n=Number(d("latest-score-date")??"0"),e=[],r=0;for await(let s of H(t,n))r=Math.max(s.timeAchieved??0,r),e.push(s);await S({scores:e,latestTimestamp:r})}async function v(){let t=[];for await(let n of R(document))t.push(n);await S({scores:t})}async function O(t=document){let n={},e=t.querySelector(".player_classemblem_top img"),r=Number(e?.src.split("_").slice(-1)[0]?.split(".")[0]??"0");r>0&&(n.dan=k[r]);let s=t.querySelector(".player_classemblem_base img"),o=Number(s?.src.split("_").slice(-1)[0]?.split(".")[0]??"0");o>0&&(n.emblem=k[o]),await S({classes:n})}function q(){window.open(`${I}/client-file-flow/${$}`);let t=`
	  <div id="api-key-setup">
		<form id="api-key-form">
		  <input type="text" id="api-key-form-key" placeholder="Copy API key here"/>
		  <input type="submit" value="Save"/>
		</form>
	  </div>
	`;document.querySelector(".clearfix")?.insertAdjacentHTML("afterend",t),document.querySelector("#api-key-setup")?.addEventListener("submit",K)}async function K(t){t.preventDefault();let n=document.querySelector("#api-key-form-key")?.value;if(!n){l("No API key received?");return}let e=await fetch(`${I}/api/v1/users/me`,{headers:{authorization:`Bearer ${n}`}}).then(r=>r.json());if(!e.success){l(`Invalid API key: ${e.description}`);return}x("api-key",n),location.reload()}function h(t,n){!d("api-key")&&confirm("You don't have an API key set up. Please set up an API key before proceeding.")&&(location.href="https://chunithm-net-eng.com/mobile/home/");let e=document.createElement("a");return e.id="kt-import-button",e.style.cssText="color:#fff;font-size:1em;font-weight:bold;padding:1rem;margin:1rem auto;display:block;width:-moz-fit-content;width:fit-content;text-decoration:none;border-radius:.5rem;border:3px solid #567;background-color:#234;text-align:center;cursor:pointer;-webkit-user-select:none;-ms-user-select:none;user-select:none;filter:brightness(0.7);transition:.2s",e.append(document.createTextNode(t)),document.querySelector(".clearfix")?.insertAdjacentElement("afterend",e),e.onclick=n,e}function j(){let t=document.createElement("div");t.style.cssText="color: rgb(255, 255, 255); padding: 1rem; margin: 1rem auto; display: block; width: 460px; border-radius: 0.5rem; border: 3px solid rgb(85, 102, 119); background-color: rgb(34, 51, 68); text-align: left; line-height: 1.2rem; font-size: 12px;";let n="You don't have an API key set up. Please set up an API key before proceeding.",e=document.createElement("p");d("api-key")||(e.append(document.createTextNode(n)),e.append(document.createElement("br")));let r=d("api-key")?"Reconfigure API key (if broken)":"Set up API key",s=document.createElement("a");if(s.id="setup-api-key-onclick",s.append(document.createTextNode(r)),s.onclick=q,e.append(s),t.append(e),d("api-key")){let o=document.createElement("a"),c="Import recent scores (preferred)";o.onclick=async()=>{let f=await fetch("/mobile/record/playlog"),a=new DOMParser().parseFromString(await f.text(),"text/html");await D(a)},o.append(c),o.append(document.createElement("br")),t.append(o);let i=document.createElement("a"),u="Import all PBs";i.onclick=v,i.append(u),i.append(document.createElement("br")),t.append(i);let m=document.createElement("a"),p="Import dan and emblem";m.onclick=async()=>{await O(document)},m.append(p),m.append(document.createElement("br")),t.append(m)}document.querySelector(".clearfix")?.insertAdjacentElement("afterend",t),t.id="kt-import-status"}function B(){let t=document.querySelector("#kt-import-button");if(!t){console.error("No import button found?");return}t.remove();let n=h("Confirm DANGEROUS operation",async()=>{await v()}),e=`
	  <p id="kt-import-pb-warning" class="p_10" style="text-align: center; background-color: #fff">
		<span style="color: #f00">WARNING!</span>
		PB import is not recommended in general! PBs do not have timestamp data, and will not create
		sessions. Only import PBs <em>after</em> importing recent scores.
	  </p>
	`;n.insertAdjacentHTML("afterend",e)}switch(location.pathname){case"/mobile/record/musicGenre":case"/mobile/record/musicWord":case"/mobile/record/musicRank":case"/mobile/record/musicLevel":{h("IMPORT ALL PBs",B);break}case"/mobile/record/playlog":{h("IMPORT RECENT SCORES",async()=>{await D(document)});break}case"/mobile/home/":{j();break}}})();

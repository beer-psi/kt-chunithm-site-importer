"use strict";(()=>{var D=location.hostname==="chunithm-net-eng.com"?"intl":"jp",b=D==="intl"?"https://chunithm-net-eng.com/mobile":"https://new.chunithm-net.com/chuni-mobile/html/mobile";document.cookie.split(";").some(t=>t.startsWith("_t="))||(alert("Please login to CHUNITHM-NET first."),location.href=b);typeof GM_fetch<"u"&&(window.fetch=GM_fetch);console.log("KTIMPORT");var v="__ktimport__",I="prod",$={prod:{baseUrl:"https://kamaitachi.xyz",clientId:"CI2a215ade610e60ee433a1f1faf0f2615f250e80d"}},T=$[I].baseUrl,R=$[I].clientId,O=["Basic","Advanced","Expert","Master","Ultima"],A=["DAN_I","DAN_II","DAN_III","DAN_IV","DAN_V","DAN_INFINITE"];function d(t,n=null){return localStorage.getItem(`${v}${t}_${I}`)??n}function M(t,n){localStorage.setItem(`${v}${t}_${I}`,n)}function h(t,n){let e=t.querySelector(n)?.innerText.replace(/,/gu,"");if(!e)throw new Error("Could not retrieve number.");return Number(e)}function L(t){let n=/([0-9]{4})\/([0-9]{1,2})\/([0-9]{1,2}) ([0-9]{1,2}):([0-9]{2})/u.exec(t);if(!n||n.length!==6)throw new Error("Invalid timestamp format. Expected yyyy/MM/dd HH:mm.");let[e,s,r,o,i,c]=n,u=r.padStart(2,"0"),m=o.padStart(2,"0"),p=i.padStart(2,"0"),a=`${s}-${u}-${m}T${p}:${c}:00.000+09:00`;return new Date(a)}function q(t,n){let e=t.querySelector(n)?.src;if(!e)throw new Error(`Could not determine image source for element ${t.outerHTML} with selector ${n}`);let s=e.split("/").pop()?.split(".")?.[0]?.split("_")?.[1]?.toUpperCase();if(typeof s>"u")throw new Error(`Could not determine difficulty from image URL ${e}`);return s==="ULTIMATE"&&(s="ULTIMA"),s==="WORLDSEND"&&(s="WORLD'S END"),s}function S(t,n){let e=t.some(o=>o.includes("icon_clear")||o.includes("icon_hard")||o.includes("icon_absolute")||o.includes("icon_absolutep")||o.includes("icon_catastrophy")),s=t.some(o=>o.includes("icon_fullcombo"));return t.some(o=>o.includes("icon_alljustice"))?n?.justice===0&&n.attack===0&&n.miss===0?"ALL JUSTICE CRITICAL":"ALL JUSTICE":s?"FULL COMBO":e?"CLEAR":"FAILED"}function l(t){let n=document.querySelector("#kt-import-status");n||(n=document.createElement("p"),n.id="kt-import-status",n.style.cssText="text-align: center; background-color: #fff;",document.querySelector(".title")?.insertAdjacentElement("afterend",n)),n.innerText=t}async function*j(t=document,n=0){let e=Array.prototype.filter.call(t.querySelectorAll(".frame02.w400"),(r,o)=>{let i=r.querySelector(".play_datalist_date, .box_inner01")?.innerText;return i?L(i).valueOf()>n:(console.warn(`Could not retrieve timestamp for score with index ${o}.`),!0)}),s=n?` since ${new Date(n).toLocaleDateString()}...`:"...";for(let r=0;r<e.length;r++){l(`Fetching score ${r+1}/${e.length}${s}`);let o=e[r];if(!o){console.warn(`There was a hole in the NodeList? Element with index ${r} was null/undefined.`);continue}let i=q(o,".play_track_result img");if(i==="WORLD'S END")continue;let c=o.querySelector(".play_datalist_date, .box_inner01")?.innerText,u=c?L(c).valueOf():null,m=h(o,".play_musicdata_score_text"),p=[...o.querySelectorAll(".play_musicdata_icon img")].map(g=>g.src),a={score:m,lamp:S(p),matchType:"inGameID",identifier:"",difficulty:i,timeAchieved:u},f=o.querySelector("input[name=idx]")?.value,k=o.querySelector("input[name=token]")?.value;if(!f||!k){console.warn(`Could not retrieve parameters for fetching details of score with index ${r}`);continue}let H=await fetch(`${b}/record/playlog/sendPlaylogDetail/`,{method:"POST",body:`idx=${f}&token=${k}`,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(g=>g.text()),y=new DOMParser().parseFromString(H,"text/html"),w=y.querySelector(".play_data_detail_ranking_btn input[name=idx]")?.value;if(!w){console.warn(`Missing inGameID element for score ${r+1}. Yielding incomplete score with songTitle matching, which may cause inaccuracies.`),D==="jp"&&console.log("To retrieve full score details, you may need to purchase the Standard Course subscription: https://otogame-net.com/chunithm");let g=o.querySelector(".play_musicdata_title")?.innerText;if(!g){console.error(`Could not get song title for score ${r+1}. Skipping this score.`);continue}a.identifier=g,a.matchType="songTitle",yield a;continue}let x={jcrit:h(y,".text_critical"),justice:h(y,".text_justice"),attack:h(y,".text_attack"),miss:h(y,".text_miss")};a.identifier=w,a.matchType="inGameID",a.lamp=S(p,x),a.judgements=x,a.optional={maxCombo:h(y,".play_data_detail_maxcombo_block")},yield a}}async function*B(t=document){let n=t.querySelector("input[name=token]")?.value??t.cookie.split(";").find(e=>e.startsWith("_t="))?.split("=")[1];if(!n){l("Error: No token found");return}for(let e of O){l(`Fetching scores for ${e}...`);let s=await fetch(`${b}/record/musicGenre/send${e}`,{method:"POST",body:`genre=99&token=${n}`,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(i=>i.text()),o=new DOMParser().parseFromString(s,"text/html").querySelectorAll(".musiclist_box");for(let i of o){let c=i.querySelector(".play_musicdata_highscore .text_b"),u=i.querySelector("input[name=idx]")?.value;if(!c?.innerText||!u)continue;let m=Number(c.innerText.replace(/,/gu,"")),p=[...i.querySelectorAll(".play_musicdata_icon img")].map(f=>f.src);yield{score:m,lamp:S(p),matchType:"inGameID",identifier:u,difficulty:e.toUpperCase()}}}}async function P(t,n){let e=await fetch(t,{method:"GET",headers:{Authorization:`Bearer ${d("api-key")}`}}).then(o=>o.json());if(!e.success){l(`Terminal error: ${e.description}`);return}if(e.body.importStatus==="ongoing"){let o=typeof e.body.progress=="number"?e.body.progress.toString():e.body.progress.description;l(`Importing scores... ${e.description} Progress: ${o}`),setTimeout(P,1e3,t,n);return}console.debug(e.body);let{latestTimestamp:s}=n,r=`${e.description} ${e.body.import.scoreIDs.length} scores`;for(let o of e.body.import.classDeltas)r=`${r} and ${o.set} ${o.new}`;if(e.body.import.errors.length>0){r=`${r}, ${e.body.import.errors.length} > 0 (check console for details)`;for(let o of e.body.import.errors)console.error(`${o.type}: ${o.message}`)}l(r),s&&M("latest-score-date",s.toString())}async function _(t){let{scores:n=[],classes:e}=t;if(n.length===0&&!e?.dan&&!e?.emblem){l("Nothing to import.");return}let r=JSON.stringify({meta:{game:"chunithm",playtype:"Single",service:"site-importer"},scores:n,classes:e});console.debug(r),document.querySelector("#kt-import-button")?.remove(),l("Submitting scores...");let o=await fetch(`${T}/ir/direct-manual/import`,{method:"POST",headers:{authorization:`Bearer ${d("api-key")}`,"content-type":"application/json","x-user-intent":"true"},body:r}).then(c=>c.json());if(!o.success){l(`Could not submit scores to Kamaitachi: ${o.description}`);return}let i=o.body.url;l("Importing scores..."),await P(i,t)}async function C(t=document){let n=Number(d("latest-score-date")??"0"),e=[],s=0;for await(let r of j(t,n))s=Math.max(r.timeAchieved??0,s),e.push(r);await _({scores:e,latestTimestamp:s})}async function N(){let t=[];for await(let n of B(document))t.push(n);await _({scores:t})}async function K(t=document){let n={},e=t.querySelector(".player_classemblem_top img"),s=Number(e?.src.split("_").slice(-1)[0]?.split(".")[0]??"0");s>0&&(n.dan=A[s]);let r=t.querySelector(".player_classemblem_base img"),o=Number(r?.src.split("_").slice(-1)[0]?.split(".")[0]??"0");o>0&&(n.emblem=A[o]),await _({classes:n})}function G(){window.open(`${T}/client-file-flow/${R}`);let t=`
	  <div id="api-key-setup">
		<form id="api-key-form">
		  <input type="text" id="api-key-form-key" placeholder="Copy API key here"/>
		  <input type="submit" value="Save"/>
		</form>
	  </div>
	`;document.querySelector(".clearfix")?.insertAdjacentHTML("afterend",t),document.querySelector("#api-key-setup")?.addEventListener("submit",U)}async function U(t){t.preventDefault();let n=document.querySelector("#api-key-form-key")?.value;if(!n){l("No API key received?");return}let e=await fetch(`${T}/api/v1/users/me`,{headers:{authorization:`Bearer ${n}`}}).then(s=>s.json());if(!e.success){l(`Invalid API key: ${e.description}`);return}M("api-key",n),location.reload()}function E(t,n){!d("api-key")&&confirm("You don't have an API key set up. Please set up an API key before proceeding.")&&(location.href=`${b}/home/`);let e=document.createElement("a");return e.id="kt-import-button",e.style.cssText="color:#fff;font-size:1em;font-weight:bold;padding:1rem;margin:1rem auto;display:block;width:-moz-fit-content;width:fit-content;text-decoration:none;border-radius:.5rem;border:3px solid #567;background-color:#234;text-align:center;cursor:pointer;-webkit-user-select:none;-ms-user-select:none;user-select:none;filter:brightness(0.7);transition:.2s",e.append(document.createTextNode(t)),document.querySelector(".clearfix")?.insertAdjacentElement("afterend",e),e.onclick=n,e}function F(){let t=document.createElement("div");t.style.cssText="color: rgb(255, 255, 255); padding: 1rem; margin: 1rem auto; display: block; width: 460px; border-radius: 0.5rem; border: 3px solid rgb(85, 102, 119); background-color: rgb(34, 51, 68); text-align: left; line-height: 1.2rem; font-size: 12px;";let n="You don't have an API key set up. Please set up an API key before proceeding.",e=document.createElement("p");d("api-key")||(e.append(document.createTextNode(n)),e.append(document.createElement("br")));let s=d("api-key")?"Reconfigure API key (if broken)":"Set up API key",r=document.createElement("a");if(r.id="setup-api-key-onclick",r.append(document.createTextNode(s)),r.onclick=G,e.append(r),t.append(e),d("api-key")){let o=document.createElement("a"),i="Import recent scores (preferred)";o.onclick=async()=>{let a=await fetch(`${b}/record/playlog`),f=new DOMParser().parseFromString(await a.text(),"text/html");await C(f)},o.append(i),o.append(document.createElement("br")),t.append(o);let c=document.createElement("a"),u="Import all PBs";c.onclick=N,c.append(u),c.append(document.createElement("br")),t.append(c);let m=document.createElement("a"),p="Import dan and emblem";m.onclick=async()=>{await K(document)},m.append(p),m.append(document.createElement("br")),t.append(m)}document.querySelector(".clearfix")?.insertAdjacentElement("afterend",t),t.id="kt-import-status"}function W(){let t=document.querySelector("#kt-import-button");if(!t){console.error("No import button found?");return}t.remove();let n=E("Confirm DANGEROUS operation",async()=>{await N()}),e=`
	  <p id="kt-import-pb-warning" class="p_10" style="text-align: center; background-color: #fff">
		<span style="color: #f00">WARNING!</span>
		PB import is not recommended in general! PBs do not have timestamp data, and will not create
		sessions. Only import PBs <em>after</em> importing recent scores.
	  </p>
	`;n.insertAdjacentHTML("afterend",e)}switch(location.href.replace(b,"")){case"/record/musicGenre":case"/record/musicWord":case"/record/musicRank":case"/record/musicLevel":{E("IMPORT ALL PBs",W);break}case"/record/playlog":{E("IMPORT RECENT SCORES",async()=>{await C(document)});break}case"/home/":{F();break}}})();

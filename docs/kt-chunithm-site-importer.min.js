"use strict";(()=>{var D=location.hostname==="chunithm-net-eng.com"?"intl":"jp",b=D==="intl"?"https://chunithm-net-eng.com/mobile":"https://new.chunithm-net.com/chuni-mobile/html/mobile";typeof GM_fetch<"u"&&(window.fetch=GM_fetch);console.log("KTIMPORT");var C="__ktimport__",I="prod",v={prod:{baseUrl:"https://kamaitachi.xyz",clientId:"CI2a215ade610e60ee433a1f1faf0f2615f250e80d"}},T=v[I].baseUrl,O=v[I].clientId,$=101e4,q=["Basic","Advanced","Expert","Master","Ultima"],w=["DAN_I","DAN_II","DAN_III","DAN_IV","DAN_V","DAN_INFINITE"];function d(n,t=null){return localStorage.getItem(`${C}${n}_${I}`)??t}function M(n,t){localStorage.setItem(`${C}${n}_${I}`,t)}function h(n,t){let e=n.querySelector(t)?.innerText.replace(/,/gu,"");if(!e)throw new Error("Could not retrieve number.");return Number(e)}function x(n){let t=/([0-9]{4})\/([0-9]{1,2})\/([0-9]{1,2}) ([0-9]{1,2}):([0-9]{2})/u.exec(n);if(!t||t.length!==6)throw new Error("Invalid timestamp format. Expected yyyy/MM/dd HH:mm.");let[e,s,r,o,c,i]=t,u=r.padStart(2,"0"),l=o.padStart(2,"0"),p=c.padStart(2,"0"),a=`${s}-${u}-${l}T${p}:${i}:00.000+09:00`;return new Date(a)}function j(n,t){let e=n.querySelector(t)?.src;if(!e)throw new Error(`Could not determine image source for element ${n.outerHTML} with selector ${t}`);let s=e.split("/").pop()?.split(".")?.[0]?.split("_")?.[1]?.toUpperCase();if(typeof s>"u")throw new Error(`Could not determine difficulty from image URL ${e}`);return s==="ULTIMATE"&&(s="ULTIMA"),s==="WORLDSEND"&&(s="WORLD'S END"),s}function E(n,t){let e=n.some(o=>o.includes("icon_clear")||o.includes("icon_hard")||o.includes("icon_absolute")||o.includes("icon_absolutep")||o.includes("icon_catastrophy")),s=n.some(o=>o.includes("icon_fullcombo"));return n.some(o=>o.includes("icon_alljustice"))?t?.justice===0&&t.attack===0&&t.miss===0?"ALL JUSTICE CRITICAL":"ALL JUSTICE":s?"FULL COMBO":e?"CLEAR":"FAILED"}function m(n){let t=document.querySelector("#kt-import-status");t||(t=document.createElement("p"),t.id="kt-import-status",t.style.cssText="text-align: center; background-color: #fff;",document.querySelector(".title")?.insertAdjacentElement("afterend",t)),t.innerText=n}async function*B(n=document,t=0){let e=Array.prototype.filter.call(n.querySelectorAll(".frame02.w400"),(r,o)=>{let c=r.querySelector(".play_datalist_date, .box_inner01")?.innerText;return c?x(c).valueOf()>t:(console.warn(`Could not retrieve timestamp for score with index ${o}.`),!0)}),s=t?` since ${new Date(t).toLocaleDateString()}...`:"...";for(let r=0;r<e.length;r++){m(`Fetching score ${r+1}/${e.length}${s}`);let o=e[r];if(!o){console.warn(`There was a hole in the NodeList? Element with index ${r} was null/undefined.`);continue}let c=j(o,".play_track_result img");if(c==="WORLD'S END")continue;let i=o.querySelector(".play_datalist_date, .box_inner01")?.innerText,u=i?x(i).valueOf():null,l=h(o,".play_musicdata_score_text"),p=[...o.querySelectorAll(".play_musicdata_icon img")].map(g=>g.src),a={score:l,lamp:l===$?"ALL JUSTICE CRITICAL":E(p),matchType:"inGameID",identifier:"",difficulty:c,timeAchieved:u},f=o.querySelector("input[name=idx]")?.value,_=o.querySelector("input[name=token]")?.value;if(!f||!_){console.warn(`Could not retrieve parameters for fetching details of score with index ${r}`);continue}let H=await fetch(`${b}/record/playlog/sendPlaylogDetail/`,{method:"POST",body:`idx=${f}&token=${_}`,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(g=>g.text()),y=new DOMParser().parseFromString(H,"text/html"),A=y.querySelector(".play_data_detail_ranking_btn input[name=idx]")?.value;if(!A){console.warn(`Missing inGameID element for score ${r+1}. Yielding incomplete score with songTitle matching, which may cause inaccuracies.`),D==="jp"&&console.log("To retrieve full score details, you may need to purchase the Standard Course subscription: https://otogame-net.com/chunithm");let g=o.querySelector(".play_musicdata_title")?.innerText;if(!g){console.error(`Could not get song title for score ${r+1}. Skipping this score.`);continue}a.identifier=g,a.matchType="songTitle",yield a;continue}let k={jcrit:h(y,".text_critical"),justice:h(y,".text_justice"),attack:h(y,".text_attack"),miss:h(y,".text_miss")};a.identifier=A,a.matchType="inGameID",a.lamp=E(p,k),a.judgements=k,a.optional={maxCombo:h(y,".play_data_detail_maxcombo_block")},yield a}}async function*K(n=document){let t=n.querySelector("input[name=token]")?.value??n.cookie.split(";").find(e=>e.startsWith("_t="))?.split("=")[1];if(!t){m("Error: No token found");return}for(let e of q){m(`Fetching scores for ${e}...`);let s=await fetch(`${b}/record/musicGenre/send${e}`,{method:"POST",body:`genre=99&token=${t}`,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(c=>c.text()),o=new DOMParser().parseFromString(s,"text/html").querySelectorAll(".musiclist_box");for(let c of o){let i=c.querySelector(".play_musicdata_highscore .text_b"),u=c.querySelector("input[name=idx]")?.value;if(!i?.innerText||!u)continue;let l=Number(i.innerText.replace(/,/gu,"")),p=[...c.querySelectorAll(".play_musicdata_icon img")].map(f=>f.src);yield{score:l,lamp:l===$?"ALL JUSTICE CRITICAL":E(p),matchType:"inGameID",identifier:u,difficulty:e.toUpperCase()}}}}async function P(n,t){let e=await fetch(n,{method:"GET",headers:{Authorization:`Bearer ${d("api-key")}`}}).then(o=>o.json());if(!e.success){m(`Terminal error: ${e.description}`);return}if(e.body.importStatus==="ongoing"){let o=typeof e.body.progress=="number"?e.body.progress.toString():e.body.progress.description;m(`Importing scores... ${e.description} Progress: ${o}`),setTimeout(P,1e3,n,t);return}console.debug(e.body);let{latestTimestamp:s}=t,r=`${e.description} ${e.body.import.scoreIDs.length} scores`;for(let o of e.body.import.classDeltas)r=`${r} and ${o.set} ${o.new}`;if(e.body.import.errors.length>0){r=`${r}, ${e.body.import.errors.length} > 0 (check console for details)`;for(let o of e.body.import.errors)console.error(`${o.type}: ${o.message}`)}m(r),s&&M("latest-score-date",s.toString())}async function L(n){let{scores:t=[],classes:e}=n;if(t.length===0&&!e?.dan&&!e?.emblem){m("Nothing to import.");return}let r=JSON.stringify({meta:{game:"chunithm",playtype:"Single",service:"site-importer"},scores:t,classes:e});console.debug(r),document.querySelector("#kt-import-button")?.remove(),m("Submitting scores...");let o=await fetch(`${T}/ir/direct-manual/import`,{method:"POST",headers:{authorization:`Bearer ${d("api-key")}`,"content-type":"application/json","x-user-intent":"true"},body:r}).then(i=>i.json());if(!o.success){m(`Could not submit scores to Kamaitachi: ${o.description}`);return}let c=o.body.url;m("Importing scores..."),await P(c,n)}async function R(n=document){let t=Number(d("latest-score-date")??"0"),e=[],s=0;for await(let r of B(n,t))s=Math.max(r.timeAchieved??0,s),e.push(r);await L({scores:e,latestTimestamp:s})}async function N(){let n=[];for await(let t of K(document))n.push(t);await L({scores:n})}async function U(n=document){let t={},e=n.querySelector(".player_classemblem_top img"),s=Number(e?.src.split("_").slice(-1)[0]?.split(".")[0]??"0");s>0&&(t.dan=w[s-1]);let r=n.querySelector(".player_classemblem_base img"),o=Number(r?.src.split("_").slice(-1)[0]?.split(".")[0]??"0");o>0&&(t.emblem=w[o-1]),await L({classes:t})}function G(){window.open(`${T}/client-file-flow/${O}`);let n=`
	  <div id="api-key-setup">
		<form id="api-key-form">
		  <input type="text" id="api-key-form-key" placeholder="Copy API key here"/>
		  <input type="submit" value="Save"/>
		</form>
	  </div>
	`;document.querySelector(".clearfix")?.insertAdjacentHTML("afterend",n),document.querySelector("#api-key-setup")?.addEventListener("submit",F)}async function F(n){n.preventDefault();let t=document.querySelector("#api-key-form-key")?.value;if(!t){m("No API key received?");return}let e=await fetch(`${T}/api/v1/users/me`,{headers:{authorization:`Bearer ${t}`}}).then(s=>s.json());if(!e.success){m(`Invalid API key: ${e.description}`);return}M("api-key",t),location.reload()}function S(n,t){!d("api-key")&&confirm("You don't have an API key set up. Please set up an API key before proceeding.")&&(location.href=`${b}/home/`);let e=document.createElement("a");return e.id="kt-import-button",e.style.cssText="color:#fff;font-size:1em;font-weight:bold;padding:1rem;margin:1rem auto;display:block;width:-moz-fit-content;width:fit-content;text-decoration:none;border-radius:.5rem;border:3px solid #567;background-color:#234;text-align:center;cursor:pointer;-webkit-user-select:none;-ms-user-select:none;user-select:none;filter:brightness(0.7);transition:.2s",e.append(document.createTextNode(n)),document.querySelector(".clearfix")?.insertAdjacentElement("afterend",e),e.onclick=t,e}function z(){let n=document.createElement("div");n.style.cssText="color: rgb(255, 255, 255); padding: 1rem; margin: 1rem auto; display: block; width: 460px; border-radius: 0.5rem; border: 3px solid rgb(85, 102, 119); background-color: rgb(34, 51, 68); text-align: left; line-height: 1.2rem; font-size: 12px;";let t="You don't have an API key set up. Please set up an API key before proceeding.",e=document.createElement("p");d("api-key")||(e.append(document.createTextNode(t)),e.append(document.createElement("br")));let s=d("api-key")?"Reconfigure API key (if broken)":"Set up API key",r=document.createElement("a");if(r.id="setup-api-key-onclick",r.append(document.createTextNode(s)),r.onclick=G,e.append(r),n.append(e),d("api-key")){let o=document.createElement("a"),c="Import recent scores (preferred)";o.onclick=async()=>{let a=await fetch(`${b}/record/playlog`),f=new DOMParser().parseFromString(await a.text(),"text/html");await R(f)},o.append(c),o.append(document.createElement("br")),n.append(o);let i=document.createElement("a"),u="Import all PBs";i.onclick=N,i.append(u),i.append(document.createElement("br")),n.append(i);let l=document.createElement("a"),p="Import dan and emblem";l.onclick=async()=>{await U(document)},l.append(p),l.append(document.createElement("br")),n.append(l)}document.querySelector(".clearfix")?.insertAdjacentElement("afterend",n),n.id="kt-import-status"}function J(){let n=document.querySelector("#kt-import-button");if(!n){console.error("No import button found?");return}n.remove();let t=S("Confirm DANGEROUS operation",async()=>{await N()}),e=`
	  <p id="kt-import-pb-warning" class="p_10" style="text-align: center; background-color: #fff">
		<span style="color: #f00">WARNING!</span>
		PB import is not recommended in general! PBs do not have timestamp data, and will not create
		sessions. Only import PBs <em>after</em> importing recent scores.
	  </p>
	`;t.insertAdjacentHTML("afterend",e)}switch(location.href.replace(b,"")){case"/record/musicGenre":case"/record/musicWord":case"/record/musicRank":case"/record/musicLevel":{S("IMPORT ALL PBs",J);break}case"/record/playlog":{S("IMPORT RECENT SCORES",async()=>{await R(document)});break}case"/home/":{z();break}}})();

(()=>{console.log("KTIMPORT");var y="prod",E={prod:{baseUrl:"https://kamaitachi.xyz",clientId:"CI2a215ade610e60ee433a1f1faf0f2615f250e80d"}},T=E[y].baseUrl,R=E[y].clientId;var S=["Basic","Advanced","Expert","Master","Ultima"],x=["","DAN_I","DAN_II","DAN_III","DAN_IV","DAN_V","DAN_INFINITE"];typeof GM_fetch<"u"&&(fetch=GM_fetch);function f(e){return localStorage.getItem(`__ktimport__${e}_${y}`)}function A(e,t){return localStorage.setItem(`__ktimport__${e}_${y}`,t.toString())}function j(){window.open(`${T}/client-file-flow/${R}`);let e=`
	<div id="api-key-setup">
	  <form id="api-key-form">
		<input type="text" id="api-key-form-key" placeholder="Copy API key here"/>
		<input type="submit" value="Save"/>
	  </form>
	</div>
  `;document.querySelector(".clearfix").insertAdjacentHTML("afterend",e),document.querySelector("#api-key-setup").addEventListener("submit",M)}function M(e){e.preventDefault();let t=document.querySelector("#api-key-form-key").value;A("api-key",t),location.reload()}function U(){let e=document.createElement("div");e.style="color: rgb(255, 255, 255); padding: 1rem; margin: 1rem auto; display: block; width: 460px; border-radius: 0.5rem; border: 3px solid rgb(85, 102, 119); background-color: rgb(34, 51, 68); text-align: left; line-height: 1.2rem; font-size: 12px;";let t="You don't have an API key set up. Please set up an API key before proceeding.",o=document.createElement("p");f("api-key")||(o.append(document.createTextNode(t)),o.append(document.createElement("br")));let c=f("api-key")?"Reconfigure API key (if broken)":"Set up API key",n=document.createElement("a");if(n.id="setup-api-key-onclick",n.append(document.createTextNode(c)),n.onclick=j,o.append(n),e.append(o),f("api-key")){let r=document.createElement("a"),a="Import recent scores (preferred)";r.onclick=async()=>{let p=await fetch("/mobile/record/playlog"),b=new DOMParser().parseFromString(await p.text(),"text/html");await D(b)},r.append(a),r.append(document.createElement("br")),e.append(r);let s=document.createElement("a"),d="Import all PBs";s.onclick=q,s.append(d),s.append(document.createElement("br")),e.append(s);let l=document.createElement("a"),i="Import dan and emblem";l.onclick=()=>{G(document)},l.append(i),l.append(document.createElement("br")),e.append(l)}document.querySelector(".clearfix").insertAdjacentElement("afterend",e),e.id="kt-import-status"}function k(e,t){!f("api-key")&&window.confirm("You don't have an API key set up. Please set up an API key before proceeding.")&&(location.href="https://chunithm-net-eng.com/mobile/home/");let o=document.createElement("a");o.id="kt-import-button",o.style="color:#fff;font-size:1em;font-weight:bold;padding:1rem;margin:1rem auto;display:block;width:-moz-fit-content;width:fit-content;text-decoration:none;border-radius:.5rem;border:3px solid #567;background-color:#234;text-align:center;cursor:pointer;-webkit-user-select:none;-ms-user-select:none;user-select:none;filter:brightness(0.7);transition:.2s",o.append(document.createTextNode(e)),document.querySelector(".clearfix").insertAdjacentElement("afterend",o),document.querySelector("#kt-import-button").onclick=t}function m(e){let t=document.querySelector("#kt-import-status");t||(t=document.createElement("p"),t.id="kt-import-status",t.style="text-align: center; background-color: #fff;",document.querySelectorAll(".title")[0].insertAdjacentElement("afterend",t)),t.innerText=e}async function v(e,t,o){let n=await(await fetch(e,{method:"GET",headers:{Authorization:`Bearer ${f("api-key")}`}})).json();if(!n.success){m("Terminal Error: "+n.description);return}if(n.body.importStatus==="ongoing"){m("Importing scores... "+n.description+" Progress: "+n.body.progress.description),setTimeout(v,1e3,e,t,o);return}if(n.body.importStatus==="completed"){console.log(n.body);let r=n.description+` ${n.body.import.scoreIDs.length} scores`;if(t.dan&&(n.description+=` and dan ${t.dan}`),t.emblem&&(n.description+=` and emblem ${t.emblem}`),n.body.import.errors.length>0){r+=`, ${n.body.import.errors.length} errors (see console log for details)`;for(let a of n.body.import.errors)console.log(`${a.type}: ${a.message}`)}m(r),A("latest-score-date",o.valueOf());return}m(n.description)}async function I(e){let{scores:t=[],dan:o=null,emblem:c=null,saveLatestTimestamp:n=!1}=e;if(t.length===0&&o===null&&c===null){m("Nothing to import.");return}let r={};o!==null&&(r.dan=o),c!=null&&(r.emblem=c);let a={meta:{game:"chunithm",playtype:"Single",service:"site-importer"},scores:t,classes:r};console.log(JSON.stringify(a));let s=fetch(`${T}/ir/direct-manual/import`,{method:"POST",headers:{Authorization:"Bearer "+f("api-key"),"Content-Type":"application/json","X-User-Intent":"true"},body:JSON.stringify(a)});document.querySelector("#kt-import-button")?.remove(),m("Submitting scores...");let l=(await(await s).json()).body.url,i=t.length>0&&n?Math.max(...t.map(p=>p.timeAchieved.valueOf())):null;m("Importing scores..."),v(l,e,i)}function u(e,t){return Number(e.querySelector(t).innerText.replaceAll(",",""))}function w(e,t={}){let o=e.some(r=>r.includes("icon_clear")),c=e.some(r=>r.includes("icon_fullcombo"));return e.some(r=>r.includes("icon_alljustice"))?t.justice===0&&t.attack===0&&t.miss===0?"ALL JUSTICE CRITICAL":"ALL JUSTICE":c?"FULL COMBO":o?"CLEAR":"FAILED"}function K(e,t){let o=e.querySelector(t).src.split("/").pop().split(".")[0].split("_")[1].toUpperCase();return o==="ULTIMATE"&&(o="ULTIMA"),o==="WORLDSEND"&&(o="WORLD'S END"),o}function B(e){let t=e.match("([0-9]{4})/([0-9]{1,2})/([0-9]{1,2}) ([0-9]{1,2}):([0-9]{2})"),[o,c,n,r,a,s]=t;n=n.padStart(2,"0"),r=r.padStart(2,"0"),a=a.padStart(2,"0");let d=`${c}-${n}-${r}T${a}:${s}:00.000+09:00`;return new Date(d)}async function D(e=document){let t=Number(f("latest-score-date")??"0"),o=[...e.querySelectorAll(".frame02.w400")].filter(n=>{let r=n.querySelector(".play_datalist_date, .box_inner01").innerText;return B(r).valueOf()>t}),c=[];for(let n=0;n<o.length;n++){m(`Fetching recent score ${n+1}/${o.length}...`);let r=o[n],a=K(r,".play_track_result img");if(a==="WORLD'S END")continue;let s=r.querySelector("input[name=idx]").value,d=r.querySelector("input[name=token]").value,l=await fetch("/mobile/record/playlog/sendPlaylogDetail/",{method:"POST",body:`idx=${s}&token=${d}`,headers:{"Content-Type":"application/x-www-form-urlencoded"}}),i=new DOMParser().parseFromString(await l.text(),"text/html"),p={score:u(i,".play_musicdata_score_text"),lamp:"",matchType:"inGameID",identifier:i.querySelector(".play_data_detail_ranking_btn input[name=idx]").value,difficulty:a,timeAchieved:0,judgements:{jcrit:u(i,".text_critical"),justice:u(i,".text_justice"),attack:u(i,".text_attack"),miss:u(i,".text_miss")},hitMeta:{maxCombo:u(i,".play_data_detail_maxcombo_block")}},b=[...i.querySelectorAll(".play_musicdata_icon img")].map(C=>C.src);p.lamp=w(b,p.judgements);let L=i.querySelector(".play_datalist_date, .box_inner01").innerText.match("([0-9]{4})/([0-9]{1,2})/([0-9]{1,2}) ([0-9]{1,2}):([0-9]{2})"),[z,P,h,g,_,N]=L;h=h.padStart(2,"0"),g=g.padStart(2,"0"),_=_.padStart(2,"0");let $=`${P}-${h}-${g}T${_}:${N}:00.000+09:00`,O=new Date($);p.timeAchieved=O.valueOf(),c.push(p)}await I({scores:c,saveLatestTimestamp:!0})}function F(){document.querySelector("#kt-import-button").remove(),k("Confirm DANGEROUS operation",async()=>await q());let e=`
	<p id="kt-import-pb-warning" class="p_10" style="text-align: center; background-color: #fff">
	  <span style="color: #f00">WARNING!</span>
	  PB import is not recommended in general! PBs do not have timestamp data, and will not create
	  sessions. Only import PBs <em>after</em> importing recent scores.
	</p>
  `;document.querySelector("#kt-import-button").insertAdjacentHTML("afterend",e)}async function q(){let e=[],t=document.querySelector("input[name=token]")?.value??document.cookie.split(";").find(o=>o.startsWith("_t="))?.split("=")[1];if(!t){m("Error: No token found");return}for(let o=0;o<5;o++){m(`Fetching scores for ${S[o]}...`);let c=await fetch(`/mobile/record/musicGenre/send${S[o]}`,{method:"POST",body:`genre=99&token=${t}`,headers:{"Content-Type":"application/x-www-form-urlencoded"}}),r=new DOMParser().parseFromString(await c.text(),"text/html").querySelectorAll(".musiclist_box");for(let a of r){if(!a.querySelector(".play_musicdata_highscore .text_b"))continue;let d={score:u(a,".play_musicdata_highscore .text_b"),lamp:"",matchType:"inGameID",identifier:a.querySelector("input[name=idx]").value,difficulty:S[o].toUpperCase()},l=[...a.querySelectorAll(".play_musicdata_icon img")].map(i=>i.src);d.lamp=w(l),e.push(d)}}document.querySelector("#kt-import-pb-warning")?.remove(),await I({scores:e})}async function G(e=document){let t=e.querySelector(".player_classemblem_top img"),o=t?x[Number(t.src.split("_").slice(-1)[0].split(".")[0])]:null,c=e.querySelector(".player_classemblem_base img"),n=c?x[Number(c.src.split("_").slice(-1)[0].split(".")[0])]:null;await I({dan:o,emblem:n})}document.cookie.split(";").some(e=>e.startsWith("_t="))||(alert("Please login to CHUNITHM-NET first."),location.href="https://chunithm-net-eng.com");switch(location.pathname){case"/mobile/record/musicGenre":case"/mobile/record/musicWord":case"/mobile/record/musicRank":case"/mobile/record/musicLevel":k("IMPORT ALL PBs",F);break;case"/mobile/record/playlog":k("IMPORT RECENT SCORES",async()=>await D(document));break;case"/mobile/home/":U();break}})();

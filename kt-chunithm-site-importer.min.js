!function(){"use strict";console.log("KTIMPORT");const e="prod",t={prod:{baseUrl:"https://kamaitachi.xyz",clientId:"CI2a215ade610e60ee433a1f1faf0f2615f250e80d"}},o=t[e].baseUrl,n=t[e].clientId,r=["Basic","Advanced","Expert","Master","Ultima"];function i(t){return localStorage.getItem(`__ktimport__${t}_${e}`)}function a(t,o){return localStorage.setItem(`__ktimport__${t}_${e}`,o.toString())}function c(){window.open(`${o}/client-file-flow/${n}`);document.querySelector(".clearfix").insertAdjacentHTML("afterend",'\n\t<div id="api-key-setup">\n\t  <form id="api-key-form">\n\t\t<input type="text" id="api-key-form-key" placeholder="Copy API key here"/>\n\t\t<input type="submit" value="Save"/>\n\t  </form>\n\t</div>\n  '),document.querySelector("#api-key-setup").addEventListener("submit",s)}function s(e){e.preventDefault();a("api-key",document.querySelector("#api-key-form-key").value),location.reload()}function l(e,t){!i("api-key")&&window.confirm("You don't have an API key set up. Please set up an API key before proceeding.")&&(location.href="https://chunithm-net-eng.com/mobile/home/");const o=document.createElement("a");o.id="kt-import-button",o.style="color:#fff;font-size:1em;font-weight:bold;padding:1rem;margin:1rem auto;display:block;width:-moz-fit-content;width:fit-content;text-decoration:none;border-radius:.5rem;border:3px solid #567;background-color:#234;text-align:center;cursor:pointer;-webkit-user-select:none;-ms-user-select:none;user-select:none;filter:brightness(0.7);transition:.2s",o.append(document.createTextNode(e));document.querySelector(".clearfix").insertAdjacentElement("afterend",o),document.querySelector("#kt-import-button").onclick=t}function d(e){let t=document.querySelector("#kt-import-status");if(!t){t=document.createElement("p"),t.id="kt-import-status",t.style="text-align: center; background-color: #fff;";document.querySelectorAll(".title")[0].insertAdjacentElement("afterend",t)}t.innerText=e}async function m(e,t,o){const n=await fetch(e,{method:"GET",headers:{Authorization:`Bearer ${i("api-key")}`}}),r=await n.json();if(r.success){if("ongoing"===r.body.importStatus)return d("Importing scores... "+r.description+" Progress: "+r.body.progress.description),void setTimeout(m,1e3,e,t,o);if("completed"===r.body.importStatus){console.log(r.body);let e=r.description+` ${r.body.import.scoreIDs.length} scores`;if(t&&(e+=` and Dan ${t}`),r.body.import.errors.length>0){e+=`, ${r.body.import.errors.length} errors (see console log for details)`;for(const e of r.body.import.errors)console.log(`${e.type}: ${e.message}`)}return d(e),void a("latest-score-date",o.valueOf())}d(r.description)}else d("Terminal Error: "+r.description)}async function u(e,t){if(0===e.length)return void d("No scores to import.");const n={meta:{game:"chunithm",playtype:"Single",service:"site-importer"},scores:e};console.log(JSON.stringify(n));const r=fetch(`${o}/ir/direct-manual/import`,{method:"POST",headers:{Authorization:"Bearer "+i("api-key"),"Content-Type":"application/json","X-User-Intent":"true"},body:JSON.stringify(n)});document.querySelector("#kt-import-button")?.remove(),d("Submitting scores...");const a=(await(await r).json()).body.url,c=e[0].timeAchieved;d("Importing scores..."),m(a,t,c)}function p(e,t){return Number(e.querySelector(t).innerText.replaceAll(",",""))}function f(e,t={}){const o=e.some((e=>e.includes("icon_clear"))),n=e.some((e=>e.includes("icon_fullcombo")));return e.some((e=>e.includes("icon_alljustice")))?0===t.justice&&0===t.attack&&0===t.miss?"ALL JUSTICE CRITICAL":"ALL JUSTICE":n?"FULL COMBO":o?"CLEAR":"FAILED"}function y(e,t){let o=e.querySelector(t).src.split("/").pop().split(".")[0].split("_")[1].toUpperCase();return"ULTIMATE"===o&&(o="ULTIMA"),"WORLDSEND"===o&&(o="WORLD'S END"),o}async function g(e=document){const t=Number(i("latest-score-date")??"0"),o=[...e.querySelectorAll(".frame02.w400")].filter((e=>function(e){const t=e.match("([0-9]{4})/([0-9]{1,2})/([0-9]{1,2}) ([0-9]{1,2}):([0-9]{2})");let[o,n,r,i,a,c]=t;return r=r.padStart(2,"0"),i=i.padStart(2,"0"),a=a.padStart(2,"0"),new Date(`${n}-${r}-${i}T${a}:${c}:00.000+09:00`)}(e.querySelector(".play_datalist_date, .box_inner01").innerText).valueOf()>t));let n=[];for(let e=0;e<o.length;e++){d(`Fetching recent score ${e+1}/${o.length}...`);const t=o[e],r=y(t,".play_track_result img");if("WORLD'S END"===r)continue;let i=t.querySelector("input[name=idx]").value,a=t.querySelector("input[name=token]").value,c=await fetch("/mobile/record/playlog/sendPlaylogDetail/",{method:"POST",body:`idx=${i}&token=${a}`,headers:{"Content-Type":"application/x-www-form-urlencoded"}}),s=(new DOMParser).parseFromString(await c.text(),"text/html"),l={score:p(s,".play_musicdata_score_text"),lamp:"",matchType:"inGameID",identifier:s.querySelector(".play_data_detail_ranking_btn input[name=idx]").value,difficulty:r,timeAchieved:0,judgements:{jcrit:p(s,".text_critical"),justice:p(s,".text_justice"),attack:p(s,".text_attack"),miss:p(s,".text_miss")},hitMeta:{maxCombo:p(s,".play_data_detail_maxcombo_block")}};const m=[...s.querySelectorAll(".play_musicdata_icon img")].map((e=>e.src));l.lamp=f(m,l.judgements);const u=s.querySelector(".play_datalist_date, .box_inner01").innerText.match("([0-9]{4})/([0-9]{1,2})/([0-9]{1,2}) ([0-9]{1,2}):([0-9]{2})");let[g,h,b,k,S,_]=u;b=b.padStart(2,"0"),k=k.padStart(2,"0"),S=S.padStart(2,"0");const x=new Date(`${h}-${b}-${k}T${S}:${_}:00.000+09:00`);l.timeAchieved=x.valueOf(),n.push(l)}u(n)}async function h(){const e=[],t=document.querySelector("input[name=token]")?.value??document.cookie.split(";").find((e=>e.startsWith("_t=")))?.split("=")[1];if(t){for(let o=0;o<5;o++){d(`Fetching scores for ${r[o]}...`);const n=await fetch(`/mobile/record/musicGenre/send${r[o]}`,{method:"POST",body:`genre=99&token=${t}`,headers:{"Content-Type":"application/x-www-form-urlencoded"}}),i=(new DOMParser).parseFromString(await n.text(),"text/html").querySelectorAll(".musiclist_box");for(const t of i){if(!t.querySelector(".play_musicdata_highscore .text_b"))continue;const n={score:p(t,".play_musicdata_highscore .text_b"),lamp:"",matchType:"inGameID",identifier:t.querySelector("input[name=idx]").value,difficulty:r[o].toUpperCase()},i=[...t.querySelectorAll(".play_musicdata_icon img")].map((e=>e.src));n.lamp=f(i),e.push(n)}}document.querySelector("#kt-import-pb-warning")?.remove(),u(e)}else d("Error: No token found")}switch("undefined"!=typeof GM_fetch&&(fetch=GM_fetch),console.log("running"),document.cookie.split(";").some((e=>e.startsWith("_t=")))||(alert("Please login to CHUNITHM-NET first."),location.href="https://chunithm-net-eng.com"),location.pathname){case"/mobile/record/musicGenre":case"/mobile/record/musicWord":case"/mobile/record/musicRank":case"/mobile/record/musicLevel":l("IMPORT ALL PBs",(function(){document.querySelector("#kt-import-button").remove(),l("Confirm DANGEROUS operation",(async()=>await h())),document.querySelector("#kt-import-button").insertAdjacentHTML("afterend",'\n\t<p id="kt-import-pb-warning" class="p_10" style="text-align: center; background-color: #fff">\n\t  <span style="color: #f00">WARNING!</span>\n\t  PB import is not recommended in general! PBs do not have timestamp data, and will not create\n\t  sessions. Only import PBs <em>after</em> importing recent scores.\n\t</p>\n  ')}));break;case"/mobile/record/playlog":l("IMPORT RECENT SCORES",(async()=>await g(document)));break;case"/mobile/home/":!function(){const e=document.createElement("div");e.style="color: rgb(255, 255, 255); padding: 1rem; margin: 1rem auto; display: block; width: 460px; border-radius: 0.5rem; border: 3px solid rgb(85, 102, 119); background-color: rgb(34, 51, 68); text-align: left; line-height: 1.2rem; font-size: 12px;";const t=document.createElement("p");i("api-key")||(t.append(document.createTextNode("You don't have an API key set up. Please set up an API key before proceeding.")),t.append(document.createElement("br")));let o=i("api-key")?"Reconfigure API key (if broken)":"Set up API key";const n=document.createElement("a");if(n.id="setup-api-key-onclick",n.append(document.createTextNode(o)),n.onclick=c,t.append(n),e.append(t),i("api-key")){const t=document.createElement("a"),o="Import recent scores (preferred)";t.onclick=async()=>{const e=await fetch("/mobile/record/playlog"),t=(new DOMParser).parseFromString(await e.text(),"text/html");await g(t)},t.append(o),t.append(document.createElement("br")),e.append(t);const n=document.createElement("a"),r="Import all PBs";n.onclick=h,n.append(r),n.append(document.createElement("br")),e.append(n)}document.querySelector(".clearfix").insertAdjacentElement("afterend",e),e.id="kt-import-status"}()}}();
